<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="//d3js.org/d3.v5.min.js"></script>
<script src="https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js"></script>
<script src="https://unpkg.com/d3-graphviz@3.0.5/build/d3-graphviz.js"></script>
<div id="graph" style="text-align: center;"></div>
<script>

var dotIndex = 0;
var graphviz = d3.select("#graph").graphviz().growEnteringEdges(true)
    .transition(function () {
        return d3.transition("main")
            .ease(d3.easeLinear)
            .delay(100)
            .duration(1000);
    })
    .logEvents(true)
    .on("initEnd", render);

function render() {
    var dotLines = dots[dotIndex];
    var dot = dotLines.join('');
    graphviz
        .renderDot(dot)
        .on("end", function () {
            dotIndex = (dotIndex + 1) % dots.length;
            render();
        });
}

var typeMap = {
  "Blob": renderBlob,
  "Manifest": renderManifest,
  "Upload": renderUpload
};

function toGraphviz(e) {
  return typeMap[e.Type](e);
}

function renderBlob(e) {
  if (e.Method == "Head") {
  } else if (e.Method == "Get") {
  } else if (e.Method = "Post") {
  } else if (e.Method = "Patch") {
  } else {
  }
}

function renderManifest(e) {
  if (e.Method == "Head") {
  } else if (e.Method == "Get") {
  } else if (e.Method = "Put") {
  } else if (e.Method = "Delete") {
  } else {
  }
}

function renderUpload(e) {
  if (e.Method == "Head") {
  } else if (e.Method == "Get") {
  } else if (e.Method = "Post") {
  } else if (e.Method = "Patch") {
  } else if (e.Method = "Put") {
  } else {
  }
}

// TODO: This should be slightly different for image index.
function renderManifests(state) {
  return renderNodes(state, "Manifest");
}

function renderBlobs(state) {
  return renderNodes(state, "Blob");
}

function renderUploads(state) {
  return renderNodes(state, "Upload");
}

function renderNodes(state, kind) {
  let objs = [];
  for (let obj of state.objects) {
    if (obj.Kind == kind) {
      let s = `"${obj.Identifier}"`;
      if (obj.color) {
        s += ` [color="${obj.color}", penwidth=2]`;
      }
      objs.push(s);
    }
  }

  return `{
    rank=same;

    ${objs.join(';')}
  }`;
}

function renderEdges(state) {
  let edges = [];
  for (let edge of state.edges) {
    let s = `"${edge.src}" -> "${edge.dst}"`;
    if (edge.color) {
      s += ` [color="${edge.color}"]`;
    }
    edges.push(s);
  }

  // TODO If no edges, add invisible edges?
  return `${edges.join(';')}`;
}

var colors = {
  0: "orange",
  200: "green",
  201: "blue",
  202: "yellow"
  404: "red",
};

function match(obj, e) {
  return obj.Kind == e.Kind && obj.Identifier == e.Identifier && obj.Repo == e.Repo;
}

// (state, event) => state
function updateState(state, e) {
  let nodeFound = false;
  let missing = [...e.Objects];

  // Update existing node.
  for (let obj of state.objects) {
    if (!nodeFound && match(obj, e)) {
      obj.color = colors[e.Status] || "black";
      nodeFound = true;
      continue;
    }

    // Not updated.
    delete obj.color;
  }

  // Update existing edges.
  outer:
  for (let edge of state.edges) {
    for (let i = 0; i < missing.length; i++) {
      if match(edge.dst, missing[i]) {
        edge.color = colors[e.Status];
        missing.splice(i, 1);
        continue outer;
      }
    }
    
    // Not updated.
    delete edge.color;
  }

  // Add missing node.
  if (!nodeFound) {
    let obj = {
      Kind: e.Kind,
      Identifier: e.Identifier,
      Repo: e.Repo,
      color: colors[e.Status]
    }
    state.objects.push(obj);
  }

  // Add missing edges.
  for (let target of missing) {
    let edge = {
      src: {
        Kind: e.Kind,
        Identifier: e.Identifier,
        Repo: e.Repo
      },
      dst: {
        Kind: target.Kind,
        Identifier: target.Identifier,
        Repo: target.Repo
      },
      color: colors[e.Status];
    };
    state.edges.push(edge);
  }
}

function init(state) {
  return `digraph {
  newrank=true;
  rankdir=LR;

  subgraph cluster_manifests {
    label = "Manifests";
    " " [style=invis];

    ${renderManifests(state)}
  }

  subgraph cluster_blobs {
    label = "Blobs";
    "  " [style=invis];

    ${renderBlobs(state)}
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];

    ${renderUploads(state)}
  }

  ${renderEdges(state)}
}`;
}

var dots = [
    [
    `digraph {
  label = "initial state";
  
  subgraph cluster_manifests {
    label = "Manifests";
    " " [style=invis];
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    "  " [style=invis];
  }
  
  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];
  }
}`
    ],
    [
`digraph {
  newrank=true;
  rankdir=LR;
  label="blob existence checks";
  
  subgraph cluster_manifests {
    label = "Manifests";
    " " [style=invis];
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc" [color="red", penwidth=2];
    "sha256:123" [color="red", penwidth=2];
    }
  }
  
  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];
  }
  
  " " -> "sha256:abc" [style=invis];
  "sha256:abc" -> "   " [dir=back, style=invis];
}`
    ],
    [
`digraph {
  newrank=true;
  rankdir=LR;
  label="start uploads (show upload progress)";
  
  subgraph cluster_manifests {
    label = "Manifests";
    " " [style=invis];
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    "  " [style=invis];
  }
  
  subgraph cluster_uploads {
    label = "Uploads";
    
    { rank=same;
    "abc" [color="yellow", penwidth=2];
    "123" [color="yellow", penwidth=2];
    }
  }
  
  " " -> "  " [style=invis];
  "  " -> "abc" [style=invis];
}`
    ],
    [
`digraph {
  newrank=true;
  rankdir=LR;
  label="finalize uploads";
  
  subgraph cluster_manifests {
    label = "Manifests";
    " " [style=invis];
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc" [color="blue", penwidth=2];
    "sha256:123" [color="blue", penwidth=2];
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    
    { rank=same;
    "abc" [color="blue", penwidth=2];
    "123" [color="blue", penwidth=2];
    }
  }
  
  " " -> "sha256:abc" [style=invis];
  
  "sha256:abc" -> "abc" [dir=back, penwidth=2];
  "sha256:123" -> "123" [dir=back, penwidth=2];
}`
    ],
    [
`digraph {
  newrank=true;
  rankdir=LR;
  
  subgraph cluster_manifests {
    label = "Manifests";
    " " [style=invis];
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc";
    "sha256:123";
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];
  }
  
  " " -> "sha256:abc" [style=invis];
  "sha256:abc" -> "   " [style=invis];
}`
    ],
    [
`digraph {
  newrank=true;
  rankdir=LR;
  label="PUT manifest";
  
  subgraph cluster_manifests {
    label = "Manifests";
    "sha256:def" [color=blue, penwidth=2];
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc";
    "sha256:123";
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];
  }
  
  "sha256:def" -> {"sha256:abc"; "sha256:123"} [color=blue];
  "sha256:abc" -> "   " [style=invis];

}`
    ],
    [
`digraph {
  newrank=true;
  rankdir=LR;
  
  subgraph cluster_manifests {
    label = "Manifests";
    "sha256:def";
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc";
    "sha256:123";
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];
  }
  
  "sha256:def" -> {"sha256:abc"; "sha256:123"};
  "sha256:abc" -> "   " [style=invis];

}`
    ],
    [
`digraph {
  newrank=true;
  rankdir=LR;
  label="blob existence checks";
  
  subgraph cluster_manifests {
    label = "Manifests";
    "sha256:def";
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc";
    "sha256:123" [color="green", penwidth=2];
    "sha256:404" [color="red", penwidth=2];
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];
  }
  
  "sha256:def" -> {"sha256:abc"; "sha256:123"};
  "sha256:abc" -> "   " [style=invis];
}`
    ],
    [
`digraph {
  newrank=true;
  rankdir=LR;
  label="start upload (show upload progress)";
  
  subgraph cluster_manifests {
    label = "Manifests";
    "sha256:def";
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc";
    "sha256:123";
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "404" [color="yellow", penwidth=2];
  }
  
  "sha256:def" -> {"sha256:abc"; "sha256:123"};
  "sha256:abc" -> "404" [style=invis];
}`
    ],
    [
`digraph {
  newrank=true;
  rankdir=LR;
  
  subgraph cluster_manifests {
    label = "Manifests";
    "sha256:def";
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc";
    "sha256:123";
    "sha256:404" [color="blue", penwidth=2];
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "404" [color="blue", penwidth=2];
  }
  
  "sha256:def" -> {"sha256:abc"; "sha256:123"};
  "sha256:404" -> "404" [dir=back, penwidth=2];
}`
    ],
    [
    `digraph {
  newrank=true;
  rankdir=LR;
  
  subgraph cluster_manifests {
    label = "Manifests";
    "sha256:def";
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc";
    "sha256:123";
    "sha256:404";
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];
  }
  
  "sha256:def" -> {"sha256:abc"; "sha256:123"};
  "sha256:abc" -> "   " [style=invis];
}`
    ],
    [`digraph {
  newrank=true;
  rankdir=LR;
  label="PUT manifest";
  
  subgraph cluster_manifests {
    label = "Manifests";
    "sha256:def";
    "sha256:fab" [color=blue, penwidth=2];
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc";
    "sha256:123";
    "sha256:404";
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];
  }
  
  "sha256:def" -> {"sha256:abc"; "sha256:123"};
  "sha256:fab" -> {"sha256:123"; "sha256:404"} [color=blue];
  "sha256:abc" -> "   " [style=invis];
}`],
[`digraph {
  newrank=true;
  rankdir=LR;
  
  subgraph cluster_manifests {
    label = "Manifests";
    "sha256:def";
    "sha256:fab";
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc";
    "sha256:123";
    "sha256:404";
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];
  }
  
  "sha256:def" -> {"sha256:abc"; "sha256:123"};
  "sha256:fab" -> {"sha256:123"; "sha256:404"};
  "sha256:abc" -> "   " [style=invis];
}`],
[`digraph {
  newrank=true;
  rankdir=LR;
  label="GET manifest";
  
  subgraph cluster_manifests {
    label = "Manifests";
    "sha256:def";
    "sha256:fab" [color=green, penwidth=2];
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc";
    "sha256:123";
    "sha256:404";
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];
  }
  
  "sha256:def" -> {"sha256:abc"; "sha256:123"};
  "sha256:fab" -> {"sha256:123"; "sha256:404"} [color=green];
  "sha256:abc" -> "   " [style=invis];
}`],
[`digraph {
  newrank=true;
  rankdir=LR;
  label="GET blobs (show download progress)";
  
  subgraph cluster_manifests {
    label = "Manifests";
    "sha256:def";
    "sha256:fab";
  }
  
  subgraph cluster_blobs {
    label = "Blobs";
    
    { rank=same;
    "sha256:abc";
    "sha256:123" [color=green, penwidth=2];
    "sha256:404" [color=green, penwidth=2];
    }
  }

  subgraph cluster_uploads {
    label = "Uploads";
    "   " [style=invis];
  }
  
  "sha256:def" -> {"sha256:abc"; "sha256:123"};
  "sha256:fab" -> {"sha256:123"; "sha256:404"};
  "sha256:abc" -> "   " [style=invis];
}`]
];

var i = 0;
fetch('/events/' + i)
  .then(response => response.json())
  .then(data => console.log(data));

</script>
